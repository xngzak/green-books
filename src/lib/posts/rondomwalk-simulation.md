---
title: "FXでランダムに売買した場合の資産推移"
date: "2021-10-29"
categories:
  - "自由研究"
coverImage: "/images/rondomwalk-simulation.png"
coverWidth: 16
coverHeight: 9
pageView: 10
excerpt: ランダムウォークの検証と破産確率の計算方法
---

FXでは**9割の人が負ける**と言われています。

感情的になってしまうからでしょうか？資産管理が杜撰だからでしょうか？  
相場は上がるか下がるかの二択ですからランダムにトレードしても**少なくとも半数は勝つ**と考えられそうです。
ではなぜ多くの人が負けるのでしょうか。

相場はランダムに推移するものと仮定して検証します。(酔歩やランダムウォークと呼ばれます)
検証にはpythonとそのライブラリであるmatplotlibを用います。

<div class="toc"/>

- [単純なモデルで考える](#単純なモデルで考える)
- [スプレッドとは](#スプレッドとは)
- [スプレッドを含めて考える](#スプレッドを含めて考える)
- [損切幅を大きくして勝率を高める](#損切幅を大きくして勝率を高める)
- [高勝率を謳う広告に注意](#高勝率を謳う広告に注意)
- [ラッキーな億り人](#ラッキーな億り人)
- [破産確率を求める](#破産確率を求める)

## 単純なモデルで考える
コイントスをモデルに考えてみます。コインを投げて表なら+100円、裏なら-100円というゲームを10人にそれぞれ100回投げてもらったグラフが下図です。

![alt](/images/post-images/1101.webp)

資産が増えた人が5人、減った人が4人、0円に戻ってきた人が1人います。
期待値は0ですから偏りは見られません。

利確幅を10pips、損切幅を10pipsとして考えると同じ条件で勝負できると思いませんか。(pipsとはFXの取引単位です)

ではなぜFXではこうならないのでしょうか。次はこの問のヒントとなる「スプレッド」について解説します。

## スプレッドとは

例えば「日本円→米ドル」のレートと「米ドル→日本円」のレートは違います。

ドルを買うときには少し高く買い、売るときには少し安く売ることになります。この差額をスプレッドといい、金融機関の手数料になります。

つまり**注文を出した時点で少しマイナス**から始まります。

## スプレッドを含めて考える

利確幅を10pips、損切幅を10pips、スプレッドが1pipとします。  
このとき利確まで11pips動かなければいけない反面、損切までは9pipsで達してしまいます。

これでは勝率1/2を下回ります。利確幅と損切幅が1:1(これを**リスクリワード**といいます)なため期待値はマイナスになります。

勝率を求めるには以下のようにします。

```python
TP = 10       # 利確幅
SL = 10       # 損切幅
spread = 1    # スプレッド幅

winrate = (SL-spread)/(SL+TP)
```

ここでの勝率は(10-1)/(10+10) = 45%となり、期待値は-1pipsでした。

かわいそうですが10人にそれぞれ100回トレードしていただきました。  
(10万円から始めて0.1ロット固定でトレードします)

![alt](/images/post-images/1102.webp)

...あれあれ、2人は資産を増やすことに成功しています。ビギナーズラックでしょうか。さらに試行回数を増やしてもらいます。

![alt](/images/post-images/1103.webp)

10人とも見事資産を減らしてしまいました。途中まで順調に増やしていた紫の彼でさえ大数の法則には勝てなかったようです。

ここで、勝率の式をよく見ると損切幅を大きくすることで勝率を高められそうです。

## 損切幅を大きくして勝率を高める

損切幅を20pipsにしてみるとどうでしょうか。  
勝率は　(20-1)/(20+10) ≒ 63.3%　となり50%を超えます！

しかし前述のリスクリワードも変化することに注意してください。リスクリワードは1:2となり、期待値は残念ながら-1pipsです。  
期待値を求めるには以下のようにします。

```python
expectedvalue = winrate*TP-(1-winrate)*SL
#             = (SL-spread)/(SL+TP)*TP-(1-(SL-spread)/(SL+TP))*SL
#             = -spread
```

そうです。期待値はなんとスプレッド幅そのものでした。  
もしもスプレッド幅が2pipsの業者で出鱈目に取引すると2pipsずつ損していきます。

次にどれくらいの勝率があればスプレッド幅を超えるトレードができるか考えます。  
期待値を0pipsにするために必要な勝率を求めるには以下のようにします。

```python
neededwinrate = SL/(SL+TP)
(利確幅,損切幅) = (10,20)　のとき必要勝率は　20/(10+20) ≒ 66.7%　です。
```

## 高勝率を謳う広告に注意

ここまでで気づいたことは、勝率とは損切幅を大きくすることで簡単に操作できるということです。いくつかのパターンを想定して表にまとめました。(スプレッド幅は1)

![alt](/images/post-images/1104.webp)

このように利確損切を決めておけばチンパンジーが注文しても9割以上勝てる方法があります。しかし数パーセントの負けを引いた時にはドカンと負けてしまいます。反対に勝率は低くてもコツコツ負けてドカンと勝つようなこともあります。

重要なのはどれも期待値は同じということです。  
つまりトレード毎の勝率だけではその有意性を語れないということが分かりました。

## ラッキーな億り人

期待値がマイナスとはいえ、何万匹ものチンパンジーが相場で戦えば億りチンパンジーが現れる確率は0ではありません。

1000万円から始めて1億円に達する確率はどれくらいあるでしょうか。

ある海外口座を参考にレバレッジを1000倍、スプレッド幅を1pipとします。ロット数は必要証拠金を考慮して500ロットに設定します。  
資産が0になっては取引が続けられませんから資金が0になったチンパンジーには降りてもらいます。  
目標金額の1億円に達した場合も同様に降りてもらいます。

戦略はどれをとっても同じなので利確も損切も10pipsで考えると、  
45%の確率で500万増え、55％の確率で500万減ります。

![alt](/images/post-images/1105.webp)

500匹のチンパンジーに100回ずつ取引してもらいました。  
線が重なって見づらいので度数分布表にまとめます。

![alt](/images/post-images/1106.webp)

増やすことができたのはわずか27匹で、都市伝説で言われてるように9割を超えるチンパンジーは破産してしまいました。

その一方、6匹の億りチンパンジーが誕生しました。実際の取引でも偶然勝ちが続いてしまうことも多く、エントリーに有意性があるかを見極めるのは難しいことのようです。

## 破産確率を求める

破産確率を計算で求めてみます。

縦軸を500万で割ったものを数直線とみなして、45%で1進み、55%で1戻るゲームと考えます。2から始めて0に着いたら破産し終了、20に着いたら目標を達成し終了します。

r(i) を i にいるときの破産確率とし、r(2) を求めましょう。  
r(2) は 55%の確率でr(1)に推移し、45%の確率でr(3)に推することから

```python
r(2) = 0.55*r(1) + 0.45*r(3)
```

と書けます。

r(0) は破産確率1、r(20)は破産確率0ですから、同様にして r(i) は以下のようになります。​

```python
r(1)  = 0.55       + 0.45*r(2)
r(2)  = 0.55*r(1)  + 0.45*r(3)
r(3)  = 0.55*r(2)  + 0.45*r(4)
r(4)  = 0.55*r(3)  + 0.45*r(5)
r(5)  = 0.55*r(4)  + 0.45*r(6)
r(6)  = 0.55*r(5)  + 0.45*r(7)
r(7)  = 0.55*r(6)  + 0.45*r(8)
r(8)  = 0.55*r(7)  + 0.45*r(9)
r(9)  = 0.55*r(8)  + 0.45*r(10)
r(10) = 0.55*r(9)  + 0.45*r(11)
r(11) = 0.55*r(10) + 0.45*r(12)
r(12) = 0.55*r(11) + 0.45*r(13)
r(13) = 0.55*r(12) + 0.45*r(14)
r(14) = 0.55*r(13) + 0.45*r(15)
r(15) = 0.55*r(14) + 0.45*r(16)
r(16) = 0.55*r(15) + 0.45*r(17)
r(17) = 0.55*r(16) + 0.45*r(18)
r(18) = 0.55*r(17) + 0.45*r(19)
r(19) = 0.55*r(18)
```

連立方程式で解くこともできますが、三項間漸化式の一般項を求めて計算します。勝率をp、目標をnとすると、

```python
p = 0.45
n = 20

def r(i):
   a = (1-p)/p
   return (a**i-a**n)/(1-a**n)
r(2)
# 0.9909115120718022
```

約99.1%で破産することが分かりました。残りの0.9%は目標を達成する確率ではなくあくまでも破産しない確率であることに注意です。
